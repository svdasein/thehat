#!/usr/bin/env ruby
##########################################################################
# This is in a very early stage of development
#
# This script reads a Gnome Planner ( https://github.com/GNOME/planner )
# file and converts it to a TheHat flow file. 
#
# The notes field is overloaded to fill in the blanks that 
# planner doesn't support, syntax is (will be) yaml-ish
#
# usage:
# 
# planner-to-flow <thehatconfig> <plannerfile> <newflowfile>
#
##########################################################################

require 'xmlsimple'
require 'pp'

# TheHat modules
require 'thehat/wfengine'


class String
	def cleansed
		return self.gsub(/[^0-9a-z]/i, '_')
	end
end 

if ARGV.size != 3
	print "Usage: #{$0} <config.yaml> <plannerfile.xml> <outputfile.flow>\n"
	exit
end

hadError = false

begin
	workflow = Workflow.new(ARGV[0]) # workflow config file e.g. example.yaml
rescue
	print "Error attempting to open config file #{ARGV[0]}\n"
	hadError = true
end
begin
	plan = XmlSimple.xml_in(ARGV[1]) # full path to planner file
rescue
	print "Error attempting to open planner file #{ARGV[1]}\n"
	hadError = true
end

exit if hadError


tasks = Hash.new
plan['tasks'][0]['task'].each {
	|task|
	tasks[task['id']] = task
}

resources = Hash.new
if plan['resources'][0]['resource']
	plan['resources'][0]['resource'].each {
		|resource|
		resources[resource['id']] = resource
	}
end


allocations = Hash.new
if plan['allocations'][0]['allocation']
	plan['allocations'][0]['allocation'].each {
		|allocation|
		allocations[allocation['task-id']] = allocation['resource-id']
	}
end

tasks.each {
	|id,task|
	stepValues = Hash.new
	if task['name'] > ''
		stepValues['name'] = task['name'].cleansed
	else
		stepValues['name'] = "task#{id.to_s}"
	end
	if task['note']
		task['note'].gsub('\n',"\n").split("\n").each {
			|note|
			key,value = note.split(':')
			stepValues[key] = value
		}
	end
	if stepValues['group']
		stepValues['group'] = stepValues['group'].split(',')
	end
	if allocations[id.to_s]
		stepValues['owner'] = resources[allocations[id.to_s]]['name']
	end
	if task['predecessors']
		gates = Array.new
		task['predecessors'][0]['predecessor'].each {
			|predecessor|
			if tasks[predecessor['predecessor-id']]['name'] > ''
				gates.push(tasks[predecessor['predecessor-id']]['name'].cleansed)
			else
				gates.push("task#{predecessor['predecessor-id']}")
			end
		}
		stepValues['gates'] = gates
	end
	# NOTE: api needs to change to simplify this
	workflow.steps[stepValues['name']]=Step.new(workflow,stepValues['name'],stepValues)
}
print "Writing to #{ARGV[2]}\n"
workflow.saveToFile(ARGV[2]) # full path to new flow file

